var Z=Object.defineProperty;var J=(y,g,m)=>g in y?Z(y,g,{enumerable:!0,configurable:!0,writable:!0,value:m}):y[g]=m;var h=(y,g,m)=>J(y,typeof g!="symbol"?g+"":g,m);(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const y=Symbol("Comlink.proxy"),g=Symbol("Comlink.endpoint"),m=Symbol("Comlink.releaseProxy"),P=Symbol("Comlink.finalizer"),w=Symbol("Comlink.thrown"),M=e=>typeof e=="object"&&e!==null||typeof e=="function",R={canHandle:e=>M(e)&&e[y],serialize(e){const{port1:t,port2:n}=new MessageChannel;return z(e,t),[n,[n]]},deserialize(e){return e.start(),U(e)}},C={canHandle:e=>M(e)&&w in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},k=new Map([["proxy",R],["throw",C]]);function B(e,t){for(const n of e)if(t===n||n==="*"||n instanceof RegExp&&n.test(t))return!0;return!1}function z(e,t=globalThis,n=["*"]){t.addEventListener("message",function r(s){if(!s||!s.data)return;if(!B(n,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:i,type:a,path:o}=Object.assign({path:[]},s.data),l=(s.data.argumentList||[]).map(f);let c;try{const u=o.slice(0,-1).reduce((_,p)=>_[p],e),d=o.reduce((_,p)=>_[p],e);switch(a){case"GET":c=d;break;case"SET":u[o.slice(-1)[0]]=f(s.data.value),c=!0;break;case"APPLY":c=d.apply(u,l);break;case"CONSTRUCT":{const _=new d(...l);c=Y(_)}break;case"ENDPOINT":{const{port1:_,port2:p}=new MessageChannel;z(e,p),c=O(_,[_])}break;case"RELEASE":c=void 0;break;default:return}}catch(u){c={value:u,[w]:0}}Promise.resolve(c).catch(u=>({value:u,[w]:0})).then(u=>{const[d,_]=K(u);t.postMessage(Object.assign(Object.assign({},d),{id:i}),_),a==="RELEASE"&&(t.removeEventListener("message",r),A(t),P in e&&typeof e[P]=="function"&&e[P]())}).catch(u=>{const[d,_]=K({value:new TypeError("Unserializable return value"),[w]:0});t.postMessage(Object.assign(Object.assign({},d),{id:i}),_)})}),t.start&&t.start()}function I(e){return e.constructor.name==="MessagePort"}function A(e){I(e)&&e.close()}function U(e,t){return N(e,[],t)}function E(e){if(e)throw new Error("Proxy has been released and is not useable")}function L(e){return b(e,{type:"RELEASE"}).then(()=>{A(e)})}const x=new WeakMap,S="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const t=(x.get(e)||0)-1;x.set(e,t),t===0&&L(e)});function F(e,t){const n=(x.get(t)||0)+1;x.set(t,n),S&&S.register(e,t,e)}function H(e){S&&S.unregister(e)}function N(e,t=[],n=function(){}){let r=!1;const s=new Proxy(n,{get(i,a){if(E(r),a===m)return()=>{H(s),L(e),r=!0};if(a==="then"){if(t.length===0)return{then:()=>s};const o=b(e,{type:"GET",path:t.map(l=>l.toString())}).then(f);return o.then.bind(o)}return N(e,[...t,a])},set(i,a,o){E(r);const[l,c]=K(o);return b(e,{type:"SET",path:[...t,a].map(u=>u.toString()),value:l},c).then(f)},apply(i,a,o){E(r);const l=t[t.length-1];if(l===g)return b(e,{type:"ENDPOINT"}).then(f);if(l==="bind")return N(e,t.slice(0,-1));const[c,u]=D(o);return b(e,{type:"APPLY",path:t.map(d=>d.toString()),argumentList:c},u).then(f)},construct(i,a){E(r);const[o,l]=D(a);return b(e,{type:"CONSTRUCT",path:t.map(c=>c.toString()),argumentList:o},l).then(f)}});return F(s,e),s}function V(e){return Array.prototype.concat.apply([],e)}function D(e){const t=e.map(K);return[t.map(n=>n[0]),V(t.map(n=>n[1]))]}const T=new WeakMap;function O(e,t){return T.set(e,t),e}function Y(e){return Object.assign(e,{[y]:!0})}function K(e){for(const[t,n]of k)if(n.canHandle(e)){const[r,s]=n.serialize(e);return[{type:"HANDLER",name:t,value:r},s]}return[{type:"RAW",value:e},T.get(e)||[]]}function f(e){switch(e.type){case"HANDLER":return k.get(e.name).deserialize(e.value);case"RAW":return e.value}}function b(e,t,n){return new Promise(r=>{const s=$();e.addEventListener("message",function i(a){!a.data||!a.data.id||a.data.id!==s||(e.removeEventListener("message",i),r(a.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:s},t),n)})}function $(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}class j{constructor(t,n=1,r="DATA"){h(this,"__name");h(this,"__version");h(this,"__storeName");h(this,"__logEnabled");h(this,"__db");this.__name=t,this.__version=n,this.__storeName=r,this.__logEnabled=!1}enableLog(){this.__logEnabled=!0}__logStart(t){this.__logEnabled&&console.time(`ModelStoreLog_${this.__name}_${this.__storeName}_${t}`)}__logEnd(t){this.__logEnabled&&console.timeEnd(`ModelStoreLog_${this.__name}_${this.__storeName}_${t}`)}close(){return new Promise(t=>{this.__db&&(this.__db.close(),t(!0))})}__open(){return new Promise((t,n)=>{if(this.__db)t(this.__db);else{const r=indexedDB.open(this.__name,this.__version);r.onupgradeneeded=()=>{const s=r.result;s.objectStoreNames.contains(this.__name)||s.createObjectStore(this.__storeName)},r.onblocked=s=>{this.__logEnd("getKey"),n({type:"onblocked",event:s})},r.onerror=s=>{this.__logEnd("getKey"),n({type:"onblocked",event:s})},r.onsuccess=()=>{this.__db=r.result,t(r.result)}}})}getUUID(){return crypto.randomUUID()}getJsonKey(t){return new Promise(async(n,r)=>{this.__logStart("getKey");try{const i=(await this.__open()).transaction(this.__storeName);i.onerror=l=>{this.__logEnd("getKey"),r({type:"store tx error",event:l})};const o=i.objectStore(this.__storeName).get(t);o.onsuccess=()=>{this.__logEnd("getKey"),n(o.result)}}catch(s){this.__logEnd("getKey"),r(s)}})}getBufferKey(t){return new Promise(async(n,r)=>{this.__logStart("getKey");try{const i=(await this.__open()).transaction(this.__storeName);i.onerror=l=>{this.__logEnd("getKey"),r({type:"store tx error",event:l})};const o=i.objectStore(this.__storeName).get(t);o.onsuccess=()=>{this.__logEnd("getKey"),n(o.result)}}catch(s){this.__logEnd("getKey"),r(s)}})}setJsonKey(t,n){return new Promise(async(r,s)=>{var i;this.__logStart("setKey");try{const o=(await this.__open()).transaction(this.__storeName,"readwrite");o.onerror=u=>{this.__logEnd("setKey"),s({type:"store tx error",event:u})};const c=o.objectStore(this.__storeName).put(n,t);c.onsuccess=()=>{this.__logEnd("setKey"),r(c.result)},(i=c.transaction)==null||i.commit()}catch(a){this.__logEnd("setKey"),s(a)}})}setBufferKey(t,n){return new Promise(async(r,s)=>{var i;this.__logStart("setKey");try{const o=(await this.__open()).transaction(this.__storeName,"readwrite");o.onerror=u=>{this.__logEnd("setKey"),s({type:"store tx error",event:u})};const c=o.objectStore(this.__storeName).put(n,t);c.onsuccess=()=>{this.__logEnd("setKey"),r(c.result)},(i=c.transaction)==null||i.commit()}catch(a){this.__logEnd("setKey"),s(a)}})}deleteKey(t){return new Promise(async(n,r)=>{this.__logStart("deleteKey");try{const i=(await this.__open()).transaction(this.__storeName,"readwrite");i.onerror=l=>{this.__logEnd("deleteKey"),r({type:"store tx error",event:l})};const o=i.objectStore(this.__storeName).delete(t);o.onsuccess=()=>{this.__logEnd("deleteKey"),n(o.result)}}catch(s){this.__logEnd("deleteKey"),r(s)}})}deleteDB(){return new Promise((t,n)=>{this.__logStart("deleteDB");const r=indexedDB.deleteDatabase(this.__name);r.onsuccess=()=>{this.__logEnd("deleteDB"),t(!0)},r.onerror=s=>{this.__logEnd("deleteDB"),n({type:"onblocked",event:s})}})}}function W(e){const t={x:null,y:null,z:null},n={x:null,y:null,z:null};let r=0;for(;r<e.length;)for(let s=0;s<3;s++,r++){const i=e[r]||0;s===0&&(t.x===null&&(t.x=i),n.x===null&&(n.x=i),t.x<i&&(t.x=i),n.x>i&&(n.x=i)),s===1&&(t.y===null&&(t.y=i),n.y===null&&(n.y=i),t.y<i&&(t.y=i),n.y>i&&(n.y=i)),s===2&&(t.z===null&&(t.z=i),n.z===null&&(n.z=i),t.z<i&&(t.z=i),n.z>i&&(n.z=i))}return{X:t.x||0,Y:t.y||0,Z:t.z||0,x:n.x||0,y:n.y||0,z:n.z||0}}class X{constructor(t){h(this,"__modelStorage");this.__modelStorage=new j(t)}async getIds(t){return await this.__modelStorage.getJsonKey(t)}async getModel(t){const n=this.__modelStorage,r=await this.__modelStorage.getJsonKey(t);if(!r)return null;const s=[];r.indexID=r.index;const i=await n.getBufferKey(r.index);r.index=new Uint32Array(i),s.push(r.index.buffer);const a=await n.getBufferKey(r.position);r.positionID=r.position,r.position=new Float32Array(a),s.push(r.position.buffer);const o=W(r.position);r.boundingBox=new Float32Array([o.x,o.y,o.z,o.X,o.Y,o.Z]);const l=(o.x+o.X)/2,c=(o.y+o.Y)/2,u=(o.z+o.Z)/2,d=Math.sqrt(Math.pow((o.X-o.x)/2,2)+Math.pow((o.Y-o.y)/2,2)+Math.pow((o.Z-o.z)/2,2));return r.boundingSphere=new Float32Array([l,c,u,d]),s.push(r.boundingSphere.buffer),s.push(r.boundingBox.buffer),O(r,s)}}z(X)})();
